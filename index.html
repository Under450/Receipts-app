<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HMRC Receipt Extractor</title>

  <!-- Onyx + Gold minimal styles (keep if you already have style.css) -->
  <link rel="stylesheet" href="style.css" />

  <style>
    /* Minimal fallback styles in case style.css isn't present */
    body{margin:0;background:#111;color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    h1{color:#DAA520;margin:16px 0 8px}
    .panel{border:2px dashed #DAA520;border-radius:8px;padding:14px;margin:12px 0;background:#171717}
    .btn{background:#DAA520;color:#111;border:none;border-radius:8px;padding:10px 14px;font-weight:700}
    .btn:active{transform:scale(.98)}
    .btn-row{display:flex;flex-wrap:wrap;gap:10px}
    table{width:100%;border-collapse:collapse;margin:14px 0;background:#151515}
    th,td{border:1px solid #333;padding:8px;font-size:14px}
    th{background:#DAA520;color:#111;text-align:left}
    tfoot td{font-weight:700}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;z-index:50}
    .modal.open{display:block}
    .modal__inner{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(880px,92vw);max-height:86vh;overflow:auto;background:#161616;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.6);padding:16px}
    .modal header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px}
    .modal h2{margin:0;color:#DAA520}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .thumb{width:100%;aspect-ratio:4/5;object-fit:cover;border-radius:8px;background:#111;border:1px solid #333}
    label{font-weight:600;font-size:14px}
    input,select,textarea{width:100%;background:#0f0f0f;color:#eee;border:1px solid #333;border-radius:10px;padding:10px 12px}
    textarea{min-height:84px;resize:vertical}
    .modal .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .right{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}
    .warn{color:#ffc04d;font-weight:800}
    .badge{background:#222;border:1px solid #333;border-radius:6px;padding:2px 8px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>HMRC Receipt Extractor</h1>

    <!-- Controls -->
    <div class="panel">
      <div class="btn-row">
        <button id="btnCamera" class="btn">üì∑ Take Photo</button>
        <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none" />
        <button id="btnLibrary" class="btn">üñºÔ∏è Choose from Library</button>
        <input id="libraryInput" type="file" accept="image/*" style="display:none" />

        <button id="btnExtract" class="btn">Extract</button>
        <button id="btnExportCsv" class="btn">Export CSV</button>
        <button id="btnExportPdf" class="btn">Export PDF</button>
        <button id="btnClear" class="btn" style="background:#444;color:#eee;">Clear</button>
        <span class="badge" id="statusBadge">Ready</span>
      </div>
      <div id="previewArea" style="margin-top:12px;display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
        <img id="previewImg" class="thumb" alt="Preview" />
        <pre id="ocrText" style="margin:0;white-space:pre-wrap;flex:1;min-height:120px;background:#111;border:1px solid #333;border-radius:8px;padding:10px"></pre>
      </div>
    </div>

    <!-- Ledger -->
    <table id="receiptTable">
      <thead>
        <tr>
          <th>Supplier</th>
          <th>VAT No</th>
          <th>Date</th>
          <th>Description / Notes</th>
          <th>Net</th>
          <th>VAT</th>
          <th>Gross</th>
          <th>Method</th>
          <th>Category</th>
          <th>Audit</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="4" style="text-align:right">Totals</td>
          <td id="totalNet">¬£0.00</td>
          <td id="totalVat">¬£0.00</td>
          <td id="totalGross">¬£0.00</td>
          <td colspan="3"></td>
        </tr>
      </tfoot>
    </table>

    <!-- Manual Fix button (appears after OCR or for manual add) -->
    <div class="right">
      <button id="btnManualFix" class="btn">Manual Fix</button>
    </div>
  </div>

  <!-- Manual Fix Modal -->
  <div id="manualFixModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal__inner">
      <header>
        <h2>Manual Fix</h2>
        <span class="warn">‚ö† Totals don‚Äôt match (auto-calc will help)</span>
      </header>

      <div class="grid" style="margin-bottom:10px">
        <img id="manualThumb" class="thumb" alt="Receipt preview" />
        <div class="row">
          <div>
            <label for="manualSupplier">Supplier</label>
            <input id="manualSupplier" placeholder="Supplier name" />
          </div>
          <div>
            <label for="manualVatNo">VAT No</label>
            <input id="manualVatNo" placeholder="GB123456789" />
          </div>
          <div>
            <label for="manualDate">Date</label>
            <input id="manualDate" type="date" />
          </div>
          <div>
            <label for="manualMethod">Method</label>
            <select id="manualMethod">
              <option>Card</option>
              <option>Cash</option>
              <option>Bank Transfer</option>
              <option>Other</option>
            </select>
          </div>
          <div style="grid-column:1/-1">
            <label for="manualDescription">Description</label>
            <input id="manualDescription" placeholder="e.g., Order Details" />
          </div>
          <div style="grid-column:1/-1">
            <label for="manualNotes">Purpose / Notes</label>
            <textarea id="manualNotes" placeholder="e.g., Parts for job 570"></textarea>
          </div>
          <div>
            <label for="manualCategory">Category</label>
            <select id="manualCategory">
              <option value="">‚Äî Choose ‚Äî</option>
              <option>Office Supplies</option>
              <option>Travel</option>
              <option>Meals</option>
              <option>Tools & Equipment</option>
              <option>Vehicle (fuel/maintenance)</option>
              <option>Phone & Internet</option>
              <option>Premises (rent/rates)</option>
              <option>Insurance</option>
              <option>Professional Fees</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label for="manualGross">Gross (¬£)</label>
            <input id="manualGross" inputmode="decimal" value="0.00" />
          </div>
          <div>
            <label for="manualNet">Net (¬£)</label>
            <input id="manualNet" inputmode="decimal" value="0.00" />
          </div>
          <div>
            <label for="manualVat">VAT (¬£)</label>
            <input id="manualVat" inputmode="decimal" value="0.00" />
          </div>
        </div>
      </div>

      <div class="right">
        <button id="cancelManualFix" class="btn" style="background:#333;color:#eee">Cancel</button>
        <button id="saveManualFix" class="btn">Save</button>
      </div>
    </div>
  </div>

  <!-- App logic -->
  <script src="app.js"></script>

  <script>
    // Hook up camera/library buttons to the hidden inputs
    const fileInput = document.getElementById('fileInput');
    const libInput  = document.getElementById('libraryInput');

    document.getElementById('btnCamera').addEventListener('click', ()=>fileInput.click());
    document.getElementById('btnLibrary').addEventListener('click', ()=>libInput.click());

    // Preview selected image (either source)
    function handleImage(file){
      if(!file) return;
      const url = URL.createObjectURL(file);
      document.getElementById('previewImg').src = url;
      document.getElementById('statusBadge').textContent = 'Image loaded';
      // If you run OCR in app.js, you can also set manualThumb there.
      document.getElementById('manualThumb').src = url;
    }
    fileInput.addEventListener('change', e => handleImage(e.target.files[0]));
    libInput.addEventListener('change',  e => handleImage(e.target.files[0]));

    // Manual fix open/close
    const modal = document.getElementById('manualFixModal');
    document.getElementById('btnManualFix').addEventListener('click', ()=> modal.classList.add('open'));
    document.getElementById('cancelManualFix').addEventListener('click', ()=> modal.classList.remove('open'));
  </script>
</body>
</html>
