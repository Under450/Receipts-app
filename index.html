<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HMRC Receipt Extractor â€“ Camera Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#121212; color:#DAA520; margin:0; padding:20px; }
    h1 { text-align:center; margin:10px 0 20px; }
    .upload-box { border:2px dashed #DAA520; background:#1e1e1e; padding:16px; max-width:680px; margin:0 auto 20px; text-align:center; }
    button { background:#DAA520; color:#121212; border:none; padding:10px 14px; margin:6px; border-radius:5px; font-weight:bold; cursor:pointer; }
    button:hover { background:#fff; color:#121212; }
    #status { font-weight:bold; margin-top:8px; color:#fff; }
    #preview { display:none; margin:10px auto 0; max-width:280px; border:1px solid #333; background:#000; }
    table { width:100%; max-width:900px; margin:20px auto; border-collapse:collapse; color:#fff; }
    th, td { border:1px solid #444; padding:8px; text-align:center; }
    th { background:#DAA520; color:#121212; }
    tfoot { font-weight:bold; }
    .charts { display:flex; gap:16px; flex-wrap:wrap; justify-content:center; margin:20px auto; }
    canvas { background:#1e1e1e; padding:8px; border:1px solid #333; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>HMRC Receipt Extractor â€“ Camera/Library Test</h1>

  <div class="upload-box">
    <!-- Take Photo (camera) -->
    <input id="cameraInput" type="file"
           accept="image/*;capture=camera" capture="environment"
           style="display:none" />
    <button onclick="document.getElementById('cameraInput').click()">ðŸ“· Take Photo</button>

    <!-- Choose from Library (photo roll / files) -->
    <input id="libraryInput" type="file"
           accept="image/*" multiple
           style="display:none" />
    <button onclick="document.getElementById('libraryInput').click()">ðŸ–¼ Choose from Library</button>

    <button id="btnExtract">Extract (Demo)</button>
    <button id="btnCSV">Export CSV (Demo)</button>
    <button id="btnPDF">Export PDF (Demo)</button>
    <button id="btnClear">Clear Demo</button>

    <div id="status">Ready</div>
    <img id="preview" alt="preview">
  </div>

  <table id="receiptTable">
    <thead>
      <tr>
        <th>Supplier</th><th>VAT No</th><th>Date</th><th>Description</th>
        <th>Net</th><th>VAT</th><th>Gross</th><th>Method</th><th>Checks</th><th>Audit</th>
      </tr>
    </thead>
    <tbody><tr><td colspan="10" style="text-align:center;">No data yet</td></tr></tbody>
    <tfoot>
      <tr>
        <td colspan="4">Totals</td>
        <td id="totalNet">0</td>
        <td id="totalVAT">0</td>
        <td id="totalGross">0</td>
        <td colspan="3"></td>
      </tr>
    </tfoot>
  </table>

  <div class="charts">
    <canvas id="pieChart" width="300" height="300"></canvas>
    <canvas id="barChart" width="380" height="300"></canvas>
  </div>

  <script>
    // ----- Utilities -----
    const $ = sel => document.querySelector(sel);
    const statusEl = $('#status');
    const previewEl = $('#preview');
    function setStatus(msg){ statusEl.textContent = msg; }
    function safeLog(...args){ try{ console.log(...args); }catch(_){} }

    // ----- Image selection handlers -----
    function handleFiles(fileList){
      if(!fileList || !fileList.length){ setStatus('No file selected'); return; }
      const f = fileList[0];
      setStatus(`Loading: ${f.name || 'image'}`);
      const r = new FileReader();
      r.onload = () => {
        previewEl.src = r.result;        // dataURL, ready for OCR
        previewEl.style.display = 'block';
        setStatus('Image loaded. Ready for OCR.');
        safeLog('Preview size bytes:', r.result.length);
      };
      r.onerror = () => setStatus('Could not read file');
      r.readAsDataURL(f);
    }

    document.getElementById('cameraInput').addEventListener('change', e => handleFiles(e.target.files));
    document.getElementById('libraryInput').addEventListener('change', e => handleFiles(e.target.files));

    // ----- Demo buttons -----
    document.getElementById('btnExtract').addEventListener('click', () => {
      setStatus('Demo extract: inserting a sample row and updating charts.');
      const tbody = document.querySelector('#receiptTable tbody');
      tbody.innerHTML = `
        <tr>
          <td>Demo Store</td><td>GB123456789</td><td>2025-01-01</td>
          <td>Office Supplies</td><td>83.33</td><td>16.67</td><td>100.00</td>
          <td>Card</td><td>âœ… Totals match</td><td>Demo</td>
        </tr>`;
      document.getElementById('totalNet').textContent = '83.33';
      document.getElementById('totalVAT').textContent = '16.67';
      document.getElementById('totalGross').textContent = '100.00';
      updateCharts([100, 80, 60], [200, 150, 300]);
    });

    document.getElementById('btnCSV').addEventListener('click', () => {
      setStatus('CSV export (demo).');
      alert('CSV export demo. (Wire real CSV later)');
    });

    document.getElementById('btnPDF').addEventListener('click', () => {
      setStatus('PDF export (demo).');
      alert('PDF export demo. (Wire jsPDF later)');
    });

    document.getElementById('btnClear').addEventListener('click', () => {
      document.querySelector('#receiptTable tbody').innerHTML =
        '<tr><td colspan="10" style="text-align:center;">No data yet</td></tr>';
      document.getElementById('totalNet').textContent = '0';
      document.getElementById('totalVAT').textContent = '0';
      document.getElementById('totalGross').textContent = '0';
      updateCharts([], []);
      setStatus('Cleared.');
    });

    // ----- Charts -----
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    const barCtx = document.getElementById('barChart').getContext('2d');

    const pieChart = new Chart(pieCtx, {
      type: 'pie',
      data: { labels: ['Supplies','Travel','Meals'], datasets: [{ data: [], backgroundColor: ['#DAA520','#888','#555'] }] },
      options: { plugins: { legend: { labels: { color: '#fff' } } } }
    });

    const barChart = new Chart(barCtx, {
      type: 'bar',
      data: { labels: ['Jan','Feb','Mar'], datasets: [{ label: 'Spend (Â£)', data: [], backgroundColor: '#DAA520' }] },
      options: {
        plugins: { legend: { labels: { color: '#fff' } } },
        scales: { x: { ticks: { color:'#fff' } }, y: { beginAtZero:true, ticks: { color:'#fff' } } }
      }
    });

    function updateCharts(pieData, barData){
      pieChart.data.datasets[0].data = pieData || [];
      barChart.data.datasets[0].data = barData || [];
      pieChart.update();
      barChart.update();
    }

    // ----- iOS/Safari notes -----
    // If "Take Photo" doesn't appear: Safari address bar "aA" â†’ Website Settings â†’ Camera: Allow
    // Also ensure you're opening via HTTPS (GitHub Pages is), then hard-refresh: add ?v=9 to your URL
  </script>
</body>
</html>
